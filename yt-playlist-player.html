<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/yt-iframe-api/yt-iframe-api.html">
<link rel="import" href="elements/error-view.html">
<link rel="import" href="elements/playlist-item.html">

<dom-module id="yt-playlist-player">

  <template>
    <yt-iframe-api
      id="api"
      on-api-load="_handleAPILoad"
      on-api-error="_handleAPIError"></yt-iframe-api>
    <iron-ajax
      id="ajax"
      auto
      url="https://www.googleapis.com/youtube/v3/playlistItems"
      params="[[_getAjaxParams()]]"
      handle-as="json"
      debounce-duration="300"
      loading="{{ajaxRequestLoading}}"
      on-response="_handleAjaxResponse"
      on-error="_handleAjaxError"></iron-ajax>
    <div class="playlist">
      <div id="player"></div>
      <template is="dom-if" if="[[error]]">
        <error-view on-retry="_handleErrorRetry"></error-view>
      </template>
      <template is="dom-if" if="[[!error]]">
        <template is="dom-if" if="[[loading]]">
          <p>Loading...</p>
        </template>
        <template is="dom-if" if="[[!loading]]">
          <template is="dom-repeat" items=[[items]]>
            <playlist-item
              index="[[index]]"
              thumbnail="[[item.snippet.thumbnails.default.url]]" 
              title="[[item.snippet.title]]"
              on-cue="_handleItemCue"></playlist-item>
          </template>
        </template>  
      </template>
    </div>
  </template>

  <script>
    class YTPlaylistPlayer extends Polymer.Element {
      static get is() {
        return 'yt-playlist-player';
      }

      static get properties() {
        return {
          list: String,
          key: String,
          items: Array,
          iframeAPILoading: {
            type: Boolean,
            value: true
          },
          loading: {
            type: Boolean,
            computed: '_computeLoading(iframeAPILoading, ajaxRequestLoading)'
          },
          iframeAPIError: {
            type: Boolean,
            value: false
          },
          ajaxRequestError: {
            type: Boolean,
            value: false
          },
          error: {
            type: Boolean,
            computed: '_computeError(iframeAPIError, ajaxRequestError)'
          }
        }
      }

      _computeLoading(iframeAPILoading, ajaxRequestLoading) {
        return (iframeAPILoading || ajaxRequestLoading);
      }

      _computeError(iframeAPIError, ajaxRequestError) {
        return (iframeAPIError || ajaxRequestError);
      }

      _handleErrorRetry(event) {
        this._reload();
      }

      _handleAPILoad(event) {
        this.iframeAPILoading = false;
        new event.target.api.Player(this.$.player, {
          height: '169',
          width: '300',
          playerVars: {
            list: this.list,
            listType: 'playlist',
            showinfo: 0
          } 
        });
      }

      _handleAPIError(event) {
        this.iframeAPIError = true;
      }

      _handleAjaxResponse(event) {
        this.items = event.detail.response.items;
      }

      _handleAjaxError(event) {
        this.ajaxRequestError = true;
      }

      _getAjaxParams() {
        return { part: 'snippet', maxResults: '50', playlistId: this.list, key: this.key }
      }

      _reload() {
        this._reloadIFrameAPI();
        this._reloadAjaxRequest();
      }

      _reloadIFrameAPI() {
        this.iframeAPIError = false;
        this.$.api._loadAPI();
      }

      _reloadAjaxRequest() {
        this.ajaxRequestError = false;
        this.$.ajax.generateRequest();
      }
    }

    customElements.define(YTPlaylistPlayer.is, YTPlaylistPlayer);
  </script>
</dom-module>
