<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../yt-iframe-api/yt-iframe-api.html">
<link rel="import" href="../yt-iframe-player/yt-iframe-player.html">
<link rel="import" href="elements/error-view.html">
<link rel="import" href="yt-playlist-menu.html">

<dom-module id="yt-playlist-player">

  <template>
    <style>
      a {
        text-decoration: none;
      }

      .playlist {
        @apply --paper-font-common-base;

        background: #000;
        box-sizing: border-box;
        height: 380px;
        padding-top: 169px;
        position: relative;
        width: 300px;
      }

      .playlist-player {
        background: #000;
        height: 169px;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
      }

      .playlist-item {
        background: var(--paper-grey-900);
        box-sizing: border-box;
        color: rgba(255,255,255,var(--dark-primary-opacity));
        display: flex;
        font-size: 11px;
        padding: 5px 10px;
      }

      .playlist-item[aria-selected=true] {
        background: var(--paper-grey-600);
      }

      .playlist-item[aria-selected=true] .playlist-item-index {
        display: none;
      }

      .playlist-item[aria-selected=true] .playlist-item-current {
        display: inline-block;
      }

      .playlist-item[aria-selected=true] .playlist-item-thumbnail {
        border: 2px solid #FF0000;
        margin: 2px;
      }

      .playlist-item-index, .playlist-item-current {
        color: rgba(255,255,255,var(--dark-secondary-opacity));
        height: 44px;
        line-height: 44px;
        min-width: 10px;
        padding-right: 9px;
        text-align: center;
      }

      .playlist-item-current {
        color: rgba(255,255,255,var(--dark-primary-opacity));
        display: none;
      }

      .playlist-item-thumbnail {
        background-position: 0 -6px;
        background-size: 64px 48px;
        display: inline-block;
        flex: none;
        height: 36px;
        margin: 4px;
        width: 64px;
      }

      .playlist-item-title {
        font-size: 120%;
        line-height: 1.25;
        max-height: 2.6em;
        overflow: hidden;
        padding-left: 9px;
        padding-top: 5px;
      }
    </style>
    
    <yt-iframe-api
      id="api"
      on-api-load="_handleAPILoad"
      on-api-error="_handleAPIError"></yt-iframe-api>
    <iron-ajax
      id="ajax"
      auto
      url="https://www.googleapis.com/youtube/v3/playlistItems"
      params="[[_getAjaxParams()]]"
      handle-as="json"
      debounce-duration="300"
      loading="{{ajaxRequestLoading}}"
      on-response="_handleAjaxResponse"
      on-error="_handleAjaxError"></iron-ajax>
    <div class="playlist">
      <yt-iframe-player
        id="player" 
        class="playlist-player"
        width="300" 
        height="169" 
        player-vars="[[iframePlayerVars]]"
        on-state-change="_handleIFramePlayerStateChange"></yt-iframe-player>
      <yt-playlist-menu
        id="menu"
        on-selected-item-changed="_handleSelectedItemChanged">
        <template is="dom-if" if="[[error]]">
          <error-view on-retry="_handleErrorRetry"></error-view>
        </template>
        <template is="dom-if" if="[[!error]]">
          <template is="dom-if" if="[[loading]]">
            <p>Loading...</p>
          </template>
          <template is="dom-if" if="[[!loading]]">
            <template is="dom-repeat" items=[[items]]>
              <a
                class="playlist-item"
                href="javascript:void(0)"
                role="menuitem">
                <div class="playlist-item-index">[[_getItemPosition(index)]]</div>
                <div class="playlist-item-current">&#x25b6;</div>
                <div 
                  class="playlist-item-thumbnail" 
                  style="background-image: url('[[item.snippet.thumbnails.default.url]]')"></div>
                <div class="playlist-item-title">[[item.snippet.title]]</div>                
              </a>      
            </template>
          </template>  
        </yt-playlist-menu>        
      </template>
    </div>
  </template>

  <script>
    class YTPlaylistPlayer extends Polymer.Element {
      static get is() {
        return 'yt-playlist-player';
      }

      static get properties() {
        return {
          list: String,
          key: String,
          items: Array,
          iframePlayerVars: {
            type: Object,
            computed: '_computeIFramePlayerVars(list)'
          },
          iframeAPILoading: {
            type: Boolean,
            value: true
          },
          loading: {
            type: Boolean,
            computed: '_computeLoading(iframeAPILoading, ajaxRequestLoading)'
          },
          iframeAPIError: {
            type: Boolean,
            value: false
          },
          ajaxRequestError: {
            type: Boolean,
            value: false
          },
          error: {
            type: Boolean,
            computed: '_computeError(iframeAPIError, ajaxRequestError)'
          }
        }
      }

      _computeIFramePlayerVars(list) {
        return { list: list, listType: 'playlist', showinfo: 0 };
      }

      _computeLoading(iframeAPILoading, ajaxRequestLoading) {
        return (iframeAPILoading || ajaxRequestLoading);
      }

      _computeError(iframeAPIError, ajaxRequestError) {
        return (iframeAPIError || ajaxRequestError);
      }

      _handleSelectedItemChanged(event) {
        var index = this.$.menu.indexOf(this.$.menu.selectedItem) - 1;
        if (index >= 0) {
          this.$.player.player.playVideoAt(index);
        }
      }

      _handleErrorRetry(event) {
        this._reload();
      }

      _handleAPILoad(event) {
        this.iframeAPILoading = false;
      }

      _handleAPIError(event) {
        this.iframeAPIError = true;
      }

      _handleAjaxResponse(event) {
        this.items = event.detail.response.items;
      }

      _handleAjaxError(event) {
        this.ajaxRequestError = true;
      }

      _handleIFramePlayerStateChange(event) {
        var playerIndex = this.$.player.player.getPlaylistIndex()
        if (playerIndex !== this.$.menu.indexOf(this.$.menu.selectedItem) - 1) {
          this.$.menu.select(playerIndex + 1);
        }
      }

      _getAjaxParams() {
        return { part: 'snippet', maxResults: '50', playlistId: this.list, key: this.key }
      }

      _getItemPosition(index) {
        return index + 1;
      }

      _isFirstItem(index) {
        return index == 0;
      }

      _reload() {
        this._reloadIFrameAPI();
        this._reloadAjaxRequest();
      }

      _reloadIFrameAPI() {
        this.iframeAPIError = false;
        this.$.api._loadAPI();
      }

      _reloadAjaxRequest() {
        this.ajaxRequestError = false;
        this.$.ajax.generateRequest();
      }
    }

    customElements.define(YTPlaylistPlayer.is, YTPlaylistPlayer);
  </script>
</dom-module>
