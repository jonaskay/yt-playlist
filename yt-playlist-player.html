<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../yt-iframe-api/yt-iframe-api.html">
<link rel="import" href="../yt-iframe-player/yt-iframe-player.html">
<link rel="import" href="elements/error-view.html">
<link rel="import" href="elements/playlist-item.html">

<dom-module id="yt-playlist-player">

  <template>
    <yt-iframe-api
      id="api"
      on-api-load="_handleAPILoad"
      on-api-error="_handleAPIError"></yt-iframe-api>
    <iron-ajax
      id="ajax"
      auto
      url="https://www.googleapis.com/youtube/v3/playlistItems"
      params="[[_getAjaxParams()]]"
      handle-as="json"
      debounce-duration="300"
      loading="{{ajaxRequestLoading}}"
      on-response="_handleAjaxResponse"
      on-error="_handleAjaxError"></iron-ajax>
    <div class="playlist">
      <yt-iframe-player id="player" 
        width="300" 
        height="169" 
        player-vars="[[iframePlayerVars]]"
        on-state-change="_handleIFramePlayerStateChange"></yt-iframe-player>
      <template is="dom-if" if="[[error]]">
        <error-view on-retry="_handleErrorRetry"></error-view>
      </template>
      <template is="dom-if" if="[[!error]]">
        <template is="dom-if" if="[[loading]]">
          <p>Loading...</p>
        </template>
        <template is="dom-if" if="[[!loading]]">
          <template is="dom-repeat" items=[[items]]>
            <playlist-item
              id="playlist-item-[[index]]"
              index="[[index]]"
              thumbnail="[[item.snippet.thumbnails.default.url]]" 
              title="[[item.snippet.title]]"
              selected="[[_isFirstItem(index)]]"
              on-cue="_handleItemCue"></playlist-item>
          </template>
        </template>  
      </template>
    </div>
  </template>

  <script>
    class YTPlaylistPlayer extends Polymer.Element {
      static get is() {
        return 'yt-playlist-player';
      }

      static get properties() {
        return {
          list: String,
          key: String,
          items: Array,
          iframePlayerVars: {
            type: Object,
            computed: '_computeIFramePlayerVars(list)'
          },
          iframeAPILoading: {
            type: Boolean,
            value: true
          },
          loading: {
            type: Boolean,
            computed: '_computeLoading(iframeAPILoading, ajaxRequestLoading)'
          },
          iframeAPIError: {
            type: Boolean,
            value: false
          },
          ajaxRequestError: {
            type: Boolean,
            value: false
          },
          error: {
            type: Boolean,
            computed: '_computeError(iframeAPIError, ajaxRequestError)'
          },
          playlistIndex: {
            type: Number,
            value: 0,
            observer: '_playlistIndexChanged'
          }
        }
      }

      _computeIFramePlayerVars(list) {
        return { list: list, listType: 'playlist' };
      }

      _computeLoading(iframeAPILoading, ajaxRequestLoading) {
        return (iframeAPILoading || ajaxRequestLoading);
      }

      _computeError(iframeAPIError, ajaxRequestError) {
        return (iframeAPIError || ajaxRequestError);
      }

      _playlistIndexChanged(newVal, oldVal) {
        this.shadowRoot.querySelector('#playlist-item-' + oldVal).selected = false;
        this.shadowRoot.querySelector('#playlist-item-' + newVal).selected = true;
      }

      _handleItemCue(event) {
        this.$.player.player.playVideoAt(event.detail);
      }

      _handleErrorRetry(event) {
        this._reload();
      }

      _handleAPILoad(event) {
        this.iframeAPILoading = false;
      }

      _handleAPIError(event) {
        this.iframeAPIError = true;
      }

      _handleAjaxResponse(event) {
        this.items = event.detail.response.items;
      }

      _handleAjaxError(event) {
        this.ajaxRequestError = true;
      }

      _handleIFramePlayerStateChange(event) {
        this.playlistIndex = this.$.player.player.getPlaylistIndex();
      }

      _getAjaxParams() {
        return { part: 'snippet', maxResults: '50', playlistId: this.list, key: this.key }
      }

      _isFirstItem(index) {
        return index == 0;
      }

      _reload() {
        this._reloadIFrameAPI();
        this._reloadAjaxRequest();
      }

      _reloadIFrameAPI() {
        this.iframeAPIError = false;
        this.$.api._loadAPI();
      }

      _reloadAjaxRequest() {
        this.ajaxRequestError = false;
        this.$.ajax.generateRequest();
      }
    }

    customElements.define(YTPlaylistPlayer.is, YTPlaylistPlayer);
  </script>
</dom-module>
