<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../yt-iframe-api/yt-iframe-api.html">

<dom-module id="yt-playlist-player">

  <template>
    <style>
      .playlist-item-thumbnail {
        background-position: 0 -6px;
        background-size: 64px 48px;
        height: 36px;
        width: 64px;
      }
    </style>

    <yt-iframe-api on-api-load="_handleAPILoad"></yt-iframe-api>
    <iron-ajax
      auto
      url="https://www.googleapis.com/youtube/v3/playlistItems"
      params="[[_getAjaxParams()]]"
      handle-as="json"
      debounce-duration="300"
      loading="{{ajaxRequestLoading}}"
      on-response="_handleAjaxResponse"></iron-ajax>
    <div class="playlist">
      <div id="player"></div>
      <template is="dom-if" if="[[loading]]">
        <p>Loading...</p>
      </template>
      <template is="dom-if" if="[[!loading]]">
        <template is="dom-repeat" items=[[items]]>
          <div>[[_getItemPosition(index)]]</div>
          <div 
            class="playlist-item-thumbnail" 
            style="background-image: url('[[item.snippet.thumbnails.default.url]]')"></div>
          <div>[[item.snippet.title]]</div>
        </template>
      </template>
    </div>
  </template>

  <script>
    class YTPlaylistPlayer extends Polymer.Element {
      static get is() {
        return 'yt-playlist-player';
      }

      static get properties() {
        return {
          list: String,
          key: String,
          items: Array,
          iframeAPILoading: {
            type: Boolean,
            value: true
          },
          loading: {
            type: Boolean,
            computed: '_computeLoading(iframeAPILoading, ajaxRequestLoading)'
          }
        }
      }

      _computeLoading(iframeAPILoading, ajaxRequestLoading) {
        return (iframeAPILoading || ajaxRequestLoading);
      }

      _handleAPILoad(event) {
        this.iframeAPILoading = false;
        new event.target.api.Player(this.$.player, {
          height: '169',
          width: '300',
          playerVars: {
            list: this.list,
            listType: 'playlist',
            showinfo: 0
          } 
        });
      }

      _handleAjaxResponse(event) {
        this.items = event.detail.response.items;
      }

      _getAjaxParams() {
        return { part: 'snippet', maxResults: '50', playlistId: this.list, key: this.key }
      }

      _getItemPosition(index) {
        return index + 1;
      }
    }

    customElements.define(YTPlaylistPlayer.is, YTPlaylistPlayer);
  </script>
</dom-module>
